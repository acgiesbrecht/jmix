<!--
  ~ Copyright 2020 Haulmont.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<view xmlns="http://jmix.io/schema/flowui/view"
      xmlns:c="http://jmix.io/schema/ui/jpql-condition"
      title="msg://EntityLogView.browse">
    <data>
        <collection id="loggedEntityDc"
                    class="io.jmix.audit.entity.LoggedEntity"
                    fetchPlan="loggedAttrs">
            <loader id="loggedEntityDl">
                <query>select e from audit_LoggedEntity e order by e.name</query>
            </loader>
        </collection>
        <collection id="loggedAttrDc"
                    class="io.jmix.audit.entity.LoggedAttribute"
                    fetchPlan="_local">
            <loader id="loggedAttrDl">
                <query>select a from audit_LoggedAttribute a where a.entity.id = :entityId</query>
            </loader>
        </collection>
        <collection id="entityLogDc"
                    class="io.jmix.audit.entity.EntityLogItem"
                    fetchPlan="logView">
            <loader id="entityLogDl">
                <query>
                    select e from audit_EntityLog e order by e.eventTs
                    <condition>
                        <and>
                            <c:jpql>
                                <c:where>e.type = :changeType</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.entity = :entityName</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.username = :user</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.eventTs &gt;= :fromDate</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.eventTs &lt;= :tillDate</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.entityRef.entityId = :entityId</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.entityRef.stringEntityId = :stringEntityId</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.entityRef.intEntityId = :intEntityId</c:where>
                            </c:jpql>
                            <c:jpql>
                                <c:where>e.entityRef.longEntityId = :longEntityId</c:where>
                            </c:jpql>
                        </and>
                    </condition>
                </query>
            </loader>
            <collection id="entityLogAttrDc" property="attributes"/>
        </collection>
    </data>

    <!--    <assign name="fieldWidth" value="theme://jmix.ui.entity-log-browse.field.width"/>-->
    <!--    <assign name="buttonWidth" value="theme://jmix.ui.entity-log-browse.button.width"/>-->

    <!--    <dialogMode height="theme://cuba.gui.dialogSize.height.xlarge"-->
    <!--                width="theme://cuba.gui.dialogSize.width.xlarge"-->
    <!--                resizable="true"/>-->

    <layout spacing="true">
        <tabs id="tabsheet" width="100%" height="100%">
            <tab id="view" label="msg://view"/>

            <!--                <split id="split1" orientation="horizontal" pos="70" width="100%">-->

            <!--                </split>-->
            <tab id="setup" label="msg://setup"/>
        </tabs>


        <vbox id="viewWrapper" width="100%" height="100%">
            <hbox id="gridRowUp">
                <span text="msg://user"/>
                <comboBox id="userField" width="${fieldWidth}"/>
                <!--                            <suggestionField id="userField" width="${fieldWidth}"/>-->
                <span text="msg://changeType"/>
                <comboBox id="changeTypeField" width="${fieldWidth}"/>
                <span text="msg://from"/>
                <dateTimePicker id="fromDateField" datatype="dateTime"/>
                <button id="searchBtn" width="${buttonWidth}" text="msg://search"/>
            </hbox>
            <hbox id="gridRowDown">
                <span text="msg://entity"/>
                <comboBox id="filterEntityNameField" width="${fieldWidth}"/>
                <span title="msg://instance"/>
                <valuePicker>
<!--                    <actions>-->
<!--                        <action id="lookup" type="entity_lookup"/>-->
<!--                        <action id="clear" type="entity_clear"/>-->
<!--                    </actions>-->
                </valuePicker>
                <!--                <entityPicker id="instancePicker" dataContainer="" width="${fieldWidth}">-->
                <!--                    <actions>-->
                <!--                        <action id="lookup" type="entity_lookup"/>-->
                <!--                        <action id="clear" type="entity_clear"/>-->
                <!--                    </actions>-->
                <!--                </entityPicker>-->
                <span text="msg://till"/>
                <dateTimePicker id="tillDateField" datatype="dateTime"/>
                <button id="clearEntityLogTableBtn" width="${buttonWidth}" text="msg://clear"/>
            </hbox>
            <split id="split1" orientation="HORIZONTAL" width="100%">
                <vbox id="entityLogTableBox"
                      expand="entityLogTable"
                      spacing="true"
                      height="100%"
                      width="100%">
                    <dataGrid id="entityLogTable" height="100%" dataContainer="entityLogDc">
                        <columns>
                            <column property="eventTs">

<!--                                <formatter>-->
<!--                                    <date format="msg://dateTimeWithSeconds"/>-->
<!--                                </formatter>-->
                            </column>
                            <column property="username"/>
                            <column property="type" />
                            <column property="entity" />
                            <column property="entityRef.entityId" />
                            <column property="entityInstanceName"/>
                        </columns>
<!--                        <simplePagination/>-->
                    </dataGrid>
                </vbox>
                <vbox id="entityLogAttrTableBox" width="100%" height="100%"
                      spacing="true">
                    <dataGrid id="entityLogAttrTable" width="100%" height="100%" dataContainer="entityLogAttrDc">
                        <columns>
                            <column property="name"/>
                            <column property="value"/>
                            <column property="valueId"/>
                            <column property="oldValue"/>
                            <column property="oldValueId"/>
                        </columns>
                    </dataGrid>
                </vbox>
            </split>
        </vbox>

        <vbox id="setupWrapper">
            <vbox id="loggedEntityTableBox" width="100%" height="100%"
                  spacing="true">
                    <dataGrid id="loggedEntityTable" width="100%" height="100%" dataContainer="loggedEntityDc">
<!--                        <actions>-->
<!--                            <action id="create"/>-->
<!--                            <action id="edit" />-->
<!--                            <action id="remove" text="msg://remove"/>-->
<!--                        </actions>-->

<!--                        <buttonsPanel alwaysVisible="true">-->
<!--                            <button action="loggedEntityTable.create" icon="FILE_O"-->
<!--                                    caption="msg://create"/>-->
<!--                            <button action="loggedEntityTable.edit" icon="PENCIL" caption="msg://edit"/>-->
<!--                            <button id="removeBtn" action="loggedEntityTable.remove"/>-->
<!--                            <button id="reloadBtn" icon="CHECK" caption="msg://reloadConfiguration"/>-->
<!--                        </buttonsPanel>-->
                        <columns>
                            <column property="name"/>
                            <column property="auto"/>
                            <column property="manual"/>
                        </columns>
                    </dataGrid>
            </vbox>
            <vbox id="loggedEntityMiscBox" height="100%" width="100%"
                  spacing="true"> <!--attributesBox -->
                <span id="miscNameLabel" text="msg://name"/>
                <comboBox width="100%" dataContainer="loggedEntityDc" id="entityNameField" property="name"/>
                <hbox id="checkersBox" width="100%">
                    <checkbox id="autoCheckBox" label="msg://auto" dataContainer="loggedEntityDc"
                              property="auto"/>
                    <checkbox id="manualCheckBox" label="msg://manual" dataContainer="loggedEntityDc"
                              property="manual"/>
                </hbox>
                <vbox id="attributesBox" width="100%"
                          expand="attributesBoxScroll">
                    <span text="msg://attributes"/>
                    <scroller id="attributesBoxScroll" width="100%">
                        <checkbox id="selectAllCheckBox" label="msg://[all]"/>
                    </scroller>
                </vbox>

                <vbox id="actionsPaneLayout" visible="false">
                    <hbox id="buttonsBox" alignItems="END" spacing="true">
                        <button id="saveBtn" text="msg://save" icon="CHECK"/>
                        <button id="cancelBtn" text="msg://cancel" icon="BAN"/>
                    </hbox>
                </vbox>
            </vbox>
        </vbox>

    </layout>
</view>
